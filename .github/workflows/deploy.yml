- name: Build
        run: |
          # If using Prisma, uncomment the next line:
          # npx prisma generate 
          npm run build
        env:
          DATABASE_URL: ${{ secrets.DB_HOST }} # Required if Prisma validates schema during build
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Create Optimized Package
        run: |
          # Prune devDependencies to keep the package small
          npm prune --omit=dev
          
          # Include node_modules so we don't have to install on EC2
          tar -czf deploy.tar.gz .next public package.json node_modules next.config.ts
          
          echo "Package Size:"
          ls -lh deploy.tar.gz

      # ... (SCP step remains the same) ...

      - name: Finalize on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_EC2_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ec2-user/app
            
            # 1. Clean old files but KEEP the .env if it exists
            find . -maxdepth 1 ! -name '.env' ! -name 'deploy.tar.gz' ! -name '.' -exec rm -rf {} +
            
            # 2. Extract new version
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz

            # 3. Securely recreate the .env
            cat <<EOF > .env
            DATABASE_URL=postgresql://${{ secrets.DB_USERNAME }}:${{ secrets.TF_VAR_db_password }}@${{ secrets.DB_HOST }}:5432/${{ secrets.DB_NAME }}
            NEXT_PUBLIC_API_URL=http://${{ secrets.AWS_EC2_IP }}:3000
            SYSTEM_ADMIN=${{ secrets.SYSTEM_ADMIN }}
            SYSTEM_ADMIN_PASSPWORD=${{ secrets.SYSTEM_ADMIN_PASSPWORD }}
            EOF
            
            # 4. Restart the app (No npm install needed here anymore!)
            pm2 delete nextjs-app || true
            pm2 start npm --name "nextjs-app" -- start -- -H 0.0.0.0
